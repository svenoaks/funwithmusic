package com.smp.funwithmusic.activities;

import static com.smp.funwithmusic.utilities.Constants.*;
import static com.smp.funwithmusic.utilities.UtilityMethods.*;

import java.util.ArrayList;

import com.fima.cardsui.objects.Card;
import com.fima.cardsui.objects.CardStack;
import com.fima.cardsui.views.CardUI;
import com.smp.funwithmusic.R;
import com.smp.funwithmusic.R.id;
import com.smp.funwithmusic.R.layout;
import com.smp.funwithmusic.objects.MusicCard;
import com.smp.funwithmusic.objects.Song;

import android.app.Activity;
import android.content.BroadcastReceiver;
import android.content.Context;
import android.content.Intent;
import android.content.IntentFilter;
import android.net.Uri;
import android.os.Bundle;
import android.view.View;
import android.view.View.OnClickListener;

public class FlowActivity extends Activity
{
	CardStack lastStack;
	CardUI mCardView;
	ArrayList<String> songs;
	private IntentFilter filter;
	private UpdateActivityReceiver receiver;

	private class UpdateActivityReceiver extends BroadcastReceiver
	{

		@Override
		public void onReceive(Context context, Intent intent)
		{
			addCardsFromList();
		}

	}

	@Override
	protected void onPause()
	{
		super.onPause();

		unregisterReceiver(receiver);
	}

	@Override
	protected void onResume()
	{
		super.onResume();
		addCardsFromList();
		registerReceiver(receiver, filter);
	}

	@Override
	protected void onCreate(Bundle savedInstanceState)
	{
		super.onCreate(savedInstanceState);
		setContentView(R.layout.activity_steve);

		mCardView = (CardUI) findViewById(R.id.cardsview);
		mCardView.setSwipeable(true);

		filter = new IntentFilter(SONG_ACTION);
		filter.addCategory(Intent.CATEGORY_DEFAULT);

		receiver = new UpdateActivityReceiver();

		// TestCards();
	}

	private void addCardsFromList()
	{
		ArrayList<Song> songs = getSongList(this);
		if (this.songs == null || this.songs.size() != songs.size())
		{
			mCardView.clearCards();
			for (Song song : songs)
			{
				addCard(song);
			}
			mCardView.refresh();
		}
	}

	// Adds to same stack if the artist is the same.

	private void addCard(Song song)
	{
		if (lastStack != null)
		{
			ArrayList<Card> lastCards = lastStack.getCards();

			if (lastCards.size() > 0)
			{
				MusicCard lastCard = (MusicCard) lastCards.get(lastCards.size() - 1);
				if (lastCard.getSong().getArtist().equals(song.getArtist()))
				{
					mCardView.addCardToLastStack(new MusicCard(song));
					return;
				}
			}
		}

		makeNewStack(song);

	}

	private void makeNewStack(Song song)
	{
		CardStack newStack = new CardStack();
		newStack.setTitle(song.getArtist());
		newStack.add(new MusicCard(song));
		mCardView.addStack(newStack);
		lastStack = newStack;
	}
	
}
